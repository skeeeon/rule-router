# NATS Rule Router Configuration
# High-Performance Message Routing with NATS JetStream and Key-Value Store Support
# Featuring Local KV Cache for Maximum Edge Performance

# NATS Server Connection and JetStream Configuration
nats:
  # Connection URLs
  urls:
    - nats://nats-server-1:4222
    - nats://nats-server-2:4222
    - nats://nats-server-3:4222
  
  # Authentication Options (choose one)
  # Option 1: Username/Password
  username: "rule-router-service"
  password: "secure-password"
  
  # Option 2: Token Authentication
  # token: "your-nats-token"
  
  # Option 3: NKey Authentication  
  # nkey: "your-nkey-here"
  
  # Option 4: JWT with .creds file (recommended for production)
  # credsFile: "/etc/nats/creds/rule-engine.creds"
  
  # TLS Configuration
  tls:
    enable: true
    certFile: "/etc/ssl/nats/client-cert.pem"
    keyFile: "/etc/ssl/nats/client-key.pem"
    caFile: "/etc/ssl/nats/ca.pem"
    insecure: false                      # Skip certificate verification (NOT recommended for production)
  
  # JetStream Consumer Configuration
  consumers:
    # Performance Tuning
    subscriberCount: 8                   # Concurrent workers per subscription (recommend: 2-4x CPU cores)
    fetchBatchSize: 64                    # Messages to fetch per pull request (1 = low latency, 10+ = high throughput)
    fetchTimeout: 1s                     # Max wait time when fetching messages (lower = more aggressive)
    maxAckPending: 1000                  # Max unacknowledged messages per consumer (backpressure control)
    
    # Reliability Settings
    ackWaitTimeout: 30s                  # Time to wait for ack before redelivery
    maxDeliver: 3                        # Max redelivery attempts before giving up
    
    # Delivery Behavior
    deliverPolicy: all                   # Options: all (process everything), new (only new messages), last (start from most recent)
    replayPolicy: instant                # Options: instant (deliver ASAP), original (replay at original timing)
  
  # NATS Connection Behavior
  connection:
    maxReconnects: -1                    # -1 = unlimited reconnection attempts
    reconnectWait: 50ms                  # Wait time between reconnection attempts

# NATS Key-Value Store Configuration with Local Cache
kv:
  enabled: true
  buckets:
    - "device_status"                    # Device operational status
    - "device_last_seen"                 # Last seen timestamps
    - "user_preferences"                 # User configuration data
    - "system_config"                    # System configuration values
  
  # Local Cache Configuration (NEW FEATURE - High Performance)
  localCache:
    enabled: true                        # Enable in-memory KV caching (default: true)
    # When enabled:
    # - All KV data loaded into memory at startup (~25x faster lookups: 50μs → 2μs)
    # - Subscribe to KV change streams for real-time updates
    # - Significant CPU reduction (10-15 percentage points)
    # - Set to false to disable caching for troubleshooting

# Logging Configuration
logging:
  level: info                            # Options: debug, info, warn, error
  outputPath: stdout                     # stdout or file path
  encoding: json                         # json or console

# Prometheus Metrics Configuration
metrics:
  enabled: true
  address: :2112
  path: /metrics
  updateInterval: 15s

